#!/bin/bash

LOGFILE=/var/log/aws_reverse_tunnel.sh.log
RETAIN_NUM_LINES=10000

if [ -z "$1" ]
  then
    echo "Must pass the AWS local port number as the first argument"
    exit 1
fi

if [ -z "$2" ]
  then
    echo "Must pass the username as the second argument"
    exit 1
fi

if [ -z "$3" ]
  then
    echo "Must pass the destination host as the third argument"
    exit 1
fi

function logsetup {  
    TMP=$(tail -n $RETAIN_NUM_LINES $LOGFILE 2>/dev/null) && echo "${TMP}" > $LOGFILE
    exec > >(tee -a $LOGFILE)
    exec 2>&1
}

function log {  
    echo "[$(date --rfc-3339=seconds)] [${INTERFACE}|${ESSID}]: $*"
}

logsetup


log "About to start the reverse tunnel" 
autossh -M 0 -o "ServerAliveInterval 30" -o "ServerAliveCountMax 3" -o "PubkeyAuthentication=yes" -o "PasswordAuthentication=no" -N -i /root/.ssh/id_rsa -R $1:localhost:22 $2@$3
